---

- name: Create EC2 instances
  ec2:
    key_name: pipeline
    instance_type: t2.micro
    image: ami-0a91cd140a1fc148a
    region: us-east-2
    group_id: 
      - sg-076007dfdb9d1006a
      - sg-f4cf3188
    instance_profile_name: EC2-Ansible
    wait: yes
    instance_tags:
      Name: devops-server-green
      application: "{{ application }}"
    exact_count: 1
    count_tag:
      application: "{{ application }}"
  register: ec2_instances

- debug: var=ec2_instances

- name: Gather Information about green instances
  ec2_instance_info:
    region: us-east-2
    filters:
      "tag:application": green
  register: myFacts

- debug: var=myFacts

- name: Wait for servers to come online
  wait_for:
    host: "{{ item.public_ip_address }}"
    port: 22
    timeout: 300
  with_items: "{{ myFacts.instances }}"
  ignore_errors: True
